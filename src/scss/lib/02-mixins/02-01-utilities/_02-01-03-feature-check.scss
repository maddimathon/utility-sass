///
/// @package @maddimathon/utility-sass@___CURRENT_VERSION___
/// @since ___PKG_VERSION___
///

@use '../../../config';

@use '../../../modules/list';
@use '../../../modules/meta';
@use '../../../modules/selector';
@use '../../../modules/string';

@use '../../01-functions' as *;

// @use '02-01-01-accessibility' as *;
// @use '02-01-02-breakpoints' as *;

/// # UTILITY MIXINS - Feature Check
/// ======================================================================== ///

@function _selector-feature-check-nesting(
    $selector,
    $parentIsBody: null,
    $parentIsRoot: null,
    $replaceRootSelector: null,
    $args...
) {
    $args: meta.keywords($args);

    @if $replaceRootSelector != null and $replaceRootSelector {
        $selector: selector.unify(#{$replaceRootSelector}, $selector);
    }

    // returns
    @if not selector.parent-exists() {
        @return $selector;
    }

    $unifyWithRoot: if(
        selector-parent-is-root() or $parentIsRoot == true and not
            $replaceRootSelector,
        true,
        false
    );

    // returns
    @if $unifyWithRoot {
        @return selector.unify(
            #{if($replaceRootSelector != null, $replaceRootSelector, &)},
            $selector
        );
    }

    @return selector.nest($selector, &);
}

@function selector-feature-check($key, $bool, $addSelectors: (), $args...) {
    $args: meta.keywords($args);

    $sels: if(
        $key == null or $key == whereSelector,
        if(
            $bool,
            (string.unquote(':where( .js )')),
            (string.unquote('.no-js'), string.unquote('.js__no-where-selector'))
        ),
        (string.unquote(':where( .js__#{if( $bool, '', 'no-' )}#{$key} )'))
    );

    $sels: _selector-feature-check-nesting($sels, $args...);

    $addSelsType: meta.type-of($addSelectors);

    $hasAddSels: if(
        (
            ($addSelsType == list and list.length($addSelectors) > 0) or
                ($addSelsType == string and string.length($addSelectors) > 0)
        ),
        true,
        false
    );

    // returns
    @if $hasAddSels {
        @return list.join(($addSelectors), ($sels), $separator: comma);
    }

    @return $sels;
}

@mixin js($args...) {
    $args: meta.keywords($args);

    @if config.$include_featureCheck {
        @at-root #{selector-feature-check(
            $key: null,
            $bool: true,
            $args...,
        )} {
            @content;
        }
    }
}

@mixin no-js($args...) {
    $args: meta.keywords($args);

    @if config.$include_featureCheck {
        @at-root #{selector-feature-check(
            $key: null,
            $bool: false,
            $args...,
        )} {
            @content;
        }
    } @else {
        @content;
    }
}

@mixin js-support($key, $args...) {
    $args: meta.keywords($args);

    @if config.$include_featureCheck {
        @if $key == whereSelector {
            @include js($args...) {
                @content;
            }
        } @else {
            @at-root #{selector-feature-check( $key, true, $args... )} {
                @content;
            }
        }
    }
}

@mixin js-no-support(
    $key,
    $addSelectors: (),
    $addSelectors_noJS: (),
    $args...
) {
    $args: meta.keywords($args);

    @if config.$include_featureCheck {
        @include no-js(
            $addSelectors: if(
                    $key == whereSelector,
                    $addSelectors,
                    $addSelectors_noJS
                ),
            $args...
        ) {
            @content;
        }

        @if $key != whereSelector {
            @at-root #{selector-feature-check( $key, false, $addSelectors: $addSelectors, $args... )} {
                @content;
            }
        }
    } @else {
        @content;
    }
}
