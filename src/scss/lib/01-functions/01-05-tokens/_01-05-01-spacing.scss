///
/// @package @maddimathon/utility-sass@___CURRENT_VERSION___
/// @since 0.1.0-pre.0
///

@use '../../../modules/list';
@use '../../../modules/map';
@use '../../../modules/math';
@use '../../../modules/meta';

@use '../../../config';
@use '../../../tokens';

@use '../01-04-properties' as *;

///
/// Uses the margin config to prepare the appropriate numerical value (rem).
///
/// @since 0.1.0-pre.0
/// @since 0.1.0-alpha.15 — Added $unit param.
/// @since 0.1.0-alpha.19 — Added $multiplier param.
///
@function mrg-value-firm($level, $unit: 1, $multiplier: 1) {
    $value: map.get(tokens.$margins, '400');

    @if not map.has-key(tokens.$margins, '#{$level}') {
        @warn "$level '#{$level}' was not a key in tokens.$margins";
    } @else {
        $value: map.get(tokens.$margins, '#{$level}');
    }

    @return math.add-unit($value * $multiplier, $unit);
}

///
/// Uses the margin config to prepare the appropriate numerical value (rem).
///
/// @since 0.1.0-pre.0
/// @since 0.1.0-alpha.15 — Added $unit param.
/// @since 0.1.0-alpha.19 — Added $multiplier param.
///
@function mrg-value-half($level, $unit: 1, $multiplier: 1) {
    //
    $firm: mrg-value-firm($level, $multiplier: $multiplier);
    $soft: mrg-value-soft($level, $multiplier: $multiplier);

    @return math.add-unit($firm - $soft, $unit);
}

$_mrgValFirm_400: mrg-value-firm('400');
$_mrgValFirm_400_softened: mrg-value-firm('400');

///
/// Uses the margin config to prepare the appropriate numerical value (rem).
///
/// @since 0.1.0-pre.0
/// @since 0.1.0-alpha.15 — Added $unit param.
/// @since 0.1.0-alpha.19 — Added $multiplier param.
///
@function mrg-value-soft($level, $unit: 1, $multiplier: 1) {
    $value: mrg-value-firm($level, $multiplier: $multiplier);

    // returns - simple softening
    @if math.num-val($level) <= 400 {
        @return math.add-unit(math.round-to-pixel($value * tokens.$margin_softener), $unit);
    }

    $pc_soften_full: calc($_mrgValFirm_400 / $value);
    $pc_soften_partial: calc(1 - $pc_soften_full);

    $_full_softener: tokens.$margin_softener;

    $_partial_softener: (
        tokens.$margin_softener + calc((1 - tokens.$margin_softener) * tokens.$margin_softener)
    );

    $value_half_full_soft: $value * $pc_soften_full * $_full_softener;

    $value_half_partial_soft: $value * $pc_soften_partial * $_partial_softener;

    @return math.add-unit(
        math.round-to-pixel($value_half_full_soft + $value_half_partial_soft),
        $unit
    );
}

///
/// Uses the widths config to prepare the appropriate numerical value (rem).
/// Returns a list of values since some are calculations that may require
/// fallbacks.
///
/// @return {list}
///
/// @since 0.1.0-pre.0
/// @since 0.1.0-alpha.19 — Added $multiplier param.
///
@function width-value($slug, $multiplier: 1, $returnAsNumber: true) {
    // returns
    @if not map.has-key(config.$widths, '#{$slug}') {
        @warn "$slug was not a key in config.$widths";
        @return ();
    }

    $num: map.get(config.$widths, '#{$slug}');

    @if meta.type-of($num) == 'number' and $multiplier != 1 {
        $num: math.round-to-pixel($num * $multiplier);
    }

    $num: math.add-unit($num, 1rem);

    @return if($returnAsNumber, $num, ($num));
}

/// ## VARIABLES ==================================== ///

///
/// Uses the margin config to print the appropriate var(...) with a
/// fallback.
///
/// @since 0.1.0-alpha.15
///
@function var-pad-firm($level) {
    $fallback: calc(1em * mrg-value-firm($level));

    @return if(
        config.$fn_var_replaceWithValue_margin,
        $fallback,
        do-var(pad-firm-#{$level}, $fallback)
    );
}

///
/// Uses the margin config to print the appropriate var(...) with a
/// fallback.
///
/// @since 0.1.0-alpha.15
///
@function var-pad-half($level) {
    $fallback: calc(1em * mrg-value-half($level));

    @return if(
        config.$fn_var_replaceWithValue_margin,
        $fallback,
        do-var(pad-half-#{$level}, $fallback)
    );
}

///
/// Uses the margin config tokens to print the appropriate var(...) with a
/// fallback.
///
/// @since 0.1.0-alpha.15
///
@function var-pad-soft($level) {
    $fallback: calc(1em * mrg-value-soft($level));

    @return if(
        config.$fn_var_replaceWithValue_margin,
        $fallback,
        do-var(pad-soft-#{$level}, $fallback)
    );
}

///
/// Uses the margin config to print the appropriate var(...) with a
/// fallback.
///
/// @since 0.1.0-pre.0
/// @since 0.1.0-alpha.19 — Added $multiplier param.
///
@function var-mrg-firm($level, $multiplier: 1) {
    $fallback: math.add-unit(mrg-value-firm($level, $multiplier: $multiplier), 1rem);

    @return if(
        config.$fn_var_replaceWithValue_margin,
        $fallback,
        do-var(mrg-firm-#{$level}, $fallback)
    );
}

///
/// Uses the margin config to print the appropriate var(...) with a
/// fallback.
///
/// @since 0.1.0-pre.0
/// @since 0.1.0-alpha.19 — Added $multiplier param.
///
@function var-mrg-half($level, $multiplier: 1) {
    $fallback: math.add-unit(mrg-value-half($level, $multiplier: $multiplier), 1rem);

    @return if(
        config.$fn_var_replaceWithValue_margin,
        $fallback,
        do-var(mrg-half-#{$level}, $fallback)
    );
}

///
/// Uses the margin config tokens to print the appropriate var(...) with a
/// fallback.
///
/// @since 0.1.0-pre.0
/// @since 0.1.0-alpha.19 — Added $multiplier param.
///
@function var-mrg-soft($level, $multiplier: 1) {
    $fallback: math.add-unit(mrg-value-soft($level, $multiplier: $multiplier), 1rem);

    @return if(
        config.$fn_var_replaceWithValue_margin,
        $fallback,
        do-var(mrg-soft-#{$level}, $fallback)
    );
}

///
/// Uses the width config to print the appropriate var(...) with a
/// fallback.
///
/// @since 0.1.0-pre.0
/// @since 0.1.0-alpha.19 — Added $multiplier param.
///
@function var-width($slug, $multiplier: 1) {
    $fallback: width-value($slug, $multiplier: $multiplier, $returnAsNumber: true);

    @if meta.type-of($fallback) == list and list.length($fallback) < 1 {
        @return do-var(width-#{$slug});
    }

    @return if(config.$fn_var_replaceWithValue_width, $fallback, do-var(width-#{$slug}, $fallback));
}

/// ## GAPS ==================================== ///

$_gaps_block: map.get(tokens.$gaps, block);
$_gaps_inline: map.get(tokens.$gaps, inline);

///
/// @since 0.1.0-pre.0
/// @since 0.1.0-alpha.19 — Added $multiplier param.
/// @since 0.1.0-alpha.21 — Added $useMarginValue param.
///
@function gap-value(
    $dir,
    $slug,
    $multiplier: 1,
    $useMarginValue: config.$fn_gapValue_useMarginValue
) {
    $dir: #{$dir};

    @if $dir != block and $dir != inline {
        @warn "$dir must be either 'block' or 'inline' (was #{$dir})";
    }

    $map: if($dir == block, $_gaps_block, $_gaps_inline);

    // returns
    @if not map.has-key($map, $slug) {
        @warn "$slug '#{$slug}' was not a key in the gaps map";
        @return ();
    }

    $num: map.get($map, $slug) * $multiplier;

    // returns
    @if $dir == block {
        //
        @if $slug == layout or $slug == layout-half {
            $_clamp_low: if(
                $useMarginValue,
                mrg-value-soft('600', $multiplier: $multiplier, $unit: 1rem),
                var-mrg-soft('600', $multiplier: $multiplier)
            );

            $_clamp_high: if(
                $useMarginValue,
                mrg-value-soft('900', $multiplier: $multiplier, $unit: 1rem),
                var-mrg-soft('900', $multiplier: $multiplier)
            );

            @return (
                math.add-unit($num, 1vw),
                clamp(
                    if($slug == layout, $_clamp_low, calc($_clamp_low/2)),
                    math.add-unit($num, 1svw),
                    if($slug == layout, $_clamp_high, calc($_clamp_high/2))
                )
            );
        }
    } @else if $dir == inline {
        //
        @if $slug == indent {
            $_clamp_low: if(
                $useMarginValue,
                mrg-value-firm('200', $multiplier: $multiplier, $unit: 1rem),
                var-mrg-firm('200', $multiplier: $multiplier)
            );

            $_clamp_high: if(
                $useMarginValue,
                mrg-value-firm('800', $multiplier: $multiplier, $unit: 1rem),
                var-mrg-firm('800', $multiplier: $multiplier)
            );

            @return (
                math.add-unit($num, 1%),
                clamp($_clamp_low, math.add-unit($num, 1%), $_clamp_high)
            );
        } @else if $slug == layout or $slug == layout-half {
            $_clamp_low: if(
                $useMarginValue,
                mrg-value-firm('400', $multiplier: $multiplier, $unit: 1rem),
                var-mrg-firm('400', $multiplier: $multiplier)
            );

            $_clamp_high: if(
                $useMarginValue,
                mrg-value-firm('900', $multiplier: $multiplier, $unit: 1rem),
                var-mrg-firm('900', $multiplier: $multiplier)
            );

            @return (
                math.add-unit($num, 1vw),
                clamp(
                    if($slug == layout, $_clamp_low, calc($_clamp_low/2)),
                    math.add-unit($num, 1svw),
                    if($slug == layout, $_clamp_high, calc($_clamp_high/2))
                )
            );
        } @else if $slug == tab {
            $_clamp_low: if(
                $useMarginValue,
                mrg-value-firm('100', $multiplier: $multiplier, $unit: 1rem),
                var-mrg-firm('100', $multiplier: $multiplier)
            );

            $_clamp_high: if(
                $useMarginValue,
                mrg-value-firm('600', $multiplier: $multiplier, $unit: 1rem),
                var-mrg-firm('600', $multiplier: $multiplier)
            );

            @return (
                math.add-unit($num, 1%),
                clamp($_clamp_low, math.add-unit($num, 1%), $_clamp_high)
            );
        }
    }

    @return ($num);
}

///
/// @since 0.1.0-pre.0
/// @since 0.1.0-alpha.19 — Added $multiplier param.
/// @since 0.1.0-alpha.21 — Added $useMarginValue param.
///
@function gap-block-value(
    $slug,
    $multiplier: 1,
    $useMarginValue: config.$fn_gapValue_useMarginValue
) {
    @return gap-value(block, $slug, $multiplier: $multiplier);
}

///
/// @since 0.1.0-pre.0
/// @since 0.1.0-alpha.19 — Added $multiplier param.
/// @since 0.1.0-alpha.21 — Added $useMarginValue param.
///
@function gap-inline-value(
    $slug,
    $multiplier: 1,
    $useMarginValue: config.$fn_gapValue_useMarginValue
) {
    @return gap-value(inline, $slug, $multiplier: $multiplier);
}

///
/// @since 0.1.0-pre.0
///
@function var-gap($dir, $slug) {
    $fallback: list.nth(gap-value($dir, $slug), 1);

    @return if(
        config.$fn_var_replaceWithValue_gap,
        $fallback,
        do-var(gap-#{$dir}-#{$slug}, $fallback)
    );
}

///
/// @since 0.1.0-pre.0
///
@function var-gap-block($slug) {
    @return var-gap(block, $slug);
}

///
/// @since 0.1.0-pre.0
///
@function var-gap-inline($slug) {
    @return var-gap(inline, $slug);
}
