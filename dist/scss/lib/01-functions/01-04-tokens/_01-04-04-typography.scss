///
/// @package @maddimathon/utility-sass@0.1.0-alpha.21
/// @since 0.1.0-pre.0
///

@use '../../../modules/list';
@use '../../../modules/map';
@use '../../../modules/math';
@use '../../../modules/string';

@use '../../../config';
@use '../../../tokens';

@use '../01-03-typography' as *;

///
/// Uses the widths config to prepare the appropriate numerical value (rem).
/// Returns a list of values since some are calculations that may require
/// fallbacks.
///
/// @param {string} $slug  Font size key to use to get the font size.
/// @param {?bool} $clampFontSize  Optional. Whether to return the font-size value as a clamp function. If null, the value is determined based on the $slug.
/// @param {number} $fontScale  Optional. Multiplier for the font size.
/// @param {bool} $multiplier  Optional. Multiplier for the font size, on top of $fontScale, if any.
/// @param {bool} $relative  Optional. Whether to return a relative value.
///
/// @return {list<number|calc>}
///
/// @since 0.1.0-pre.0
/// @since 0.1.0-alpha.18 — Added $relative param.
/// @since 0.1.0-alpha.19 — Added $multiplier param.
///
@function fs-value(
    $slug,
    $clampFontSize: null,
    $fontScale: null,
    $multiplier: 1,
    $relative: false
) {
    // returns
    @if not map.has-key(tokens.$font_sizes, $slug) {
        @warn "$slug '#{$slug}' did not match any of the font size tokens";
        @return ();
    }

    $size: map.get(tokens.$font_sizes, $slug);

    @if $clampFontSize == null {
        $clampFontSize: false;

        @if $slug == 'title' {
            $clampFontSize: true;
        }
        @if string.index($slug, 'heading-') == 1 {
            $clampFontSize: true;
        }
        @if string.index($slug, 'bigger-') == 1 {
            $clampFontSize: true;
        }
    }

    $unit: if($relative, 1em, 1rem);

    @if $fontScale == null {
        $fontScale: if($relative, 1, config.$fn_fontSizeValue_defaultFontScale);
    }

    $fontScale: $fontScale * $multiplier;

    // returns
    @if $clampFontSize {
        @return (
            math.add-unit(
                math.round-to-pixel(
                    $size * $fontScale,
                    $factor: config.$fn_fontSizeValue_roundToPixelFactor
                ),
                $unit
            ),
            clamp-font-size($size * $fontScale, $relative: $relative)
        );
    }

    @return math.add-unit(math.round-to-pixel($size * $fontScale), $unit);
}

///
/// Uses the widths config to prepare the appropriate numerical value (rem).
/// Returns a list of values since some are calculations that may require
/// fallbacks.
///
/// @return {number}
///
/// @since 0.1.0-pre.0
/// @since 0.1.0-alpha.19 — Added $multiplier param.
///
@function line-height-value($level, $multiplier: 1) {
    $value: map.get(tokens.$line_heights, '400');

    @if not map.has-key(tokens.$line_heights, '#{$level}') {
        @warn "$level was not a key in tokens.$line_heights";
    } @else {
        $value: map.get(tokens.$line_heights, '#{$level}');
    }

    @return if(
        $multiplier == 1,
        $value,
        math.round-to-pixel(
            $value * $multiplier,
            config.$fn_lineHeighteValue_roundToPixelFactor
        )
    );
}

/// ## VARIABLES ==================================== ///

///
/// Uses the line height config tokens to print the appropriate var(...) with a
/// fallback.
///
/// @since 0.1.0-pre.0
///
@function var-line-height($slug) {
    $fallback: line-height-value($slug);

    @return if(
        config.$fn_var_replaceWithValue_lineHeight,
        $fallback,
        var(--#{config.$cxPropPre}line-height-#{$slug}, $fallback)
    );
}

///
/// Uses the font size config tokens to print the appropriate var(...) with a
/// fallback.
///
/// @since 0.1.0-pre.0
///
@function var-fs($slug, $fallback: null, $relative: false) {
    //
    $var_slug: if($relative, fs-rel-#{$slug}, fs-#{$slug});

    // if theres's no fallback set, then we use the fs-value function to find one
    // returns if no fallback
    @if $fallback == null {
        $fallback: fs-value($slug, $relative: $relative);

        // returns
        @if list.length($fallback) < 1 {
            @return var(--#{config.$cxPropPre}#{$var_slug});
        }

        $fallback: list.nth($fallback, 1);
    }

    $returnFallbackOnly: config.$fn_var_replaceWithValue_fontSize;

    @if $relative {
        // prettier-ignore
        $returnFallbackOnly: $returnFallbackOnly 
            or not config.$mx_tokensFontSize_printRelative 
            or $slug == normal;
    }

    @return if(
        $returnFallbackOnly,
        $fallback,
        var(--#{config.$cxPropPre}#{$var_slug}, $fallback)
    );
}
