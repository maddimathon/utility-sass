///
/// @package @maddimathon/utility-sass@0.1.0-pre.5
/// @since 0.1.0-pre.0
///

@use '../../../config';
@use '../../../tokens';

@use '../../../modules/list';
@use '../../../modules/map';
@use '../../../modules/meta';
@use '../../../modules/selector';
@use '../../../modules/string';

@use '../../01-functions' as *;

@use '../02-01-utilities' as *;
// @use '../02-02-theming' as *;

/// # THEMING MIXINS - Modes
/// ======================================================================== ///

$_brightnessModes: filter-colour-modes-active-only(tokens.$brightnessMode_all);
$_contrastModes: filter-colour-modes-active-only(tokens.$contrastMode_all);

///
/// Conditional rules for various colour modes.  When multiple modes are passed,
/// the selectors are joined (as a list), not unified or merged.  To require
/// more than one mode, nest them.
///
/// @since 0.1.0-pre.0
///
@mixin colour-mode(
    $modes,
    $includeQuery: true,
    $includeSelectors: true,

    $modeArgs: false,
    $args...
) {
    @if not $modeArgs {
        $args: colour-mode-validate-args(
            $modes: $modes,
            $args...,
        );
    } @else {
        $args: meta.keywords($args);
    }

    $modes: map.get($args, 'modes');
    $includeDefault: map.get($args, 'includeDefault');

    $nestParentSelector: map.get($args, 'nestParentSelector');
    $unifyParentSelector: map.get($args, 'unifyParentSelector');
    $wrapParentSelector: map.get($args, 'wrapParentSelector');

    $parentSelector: map.get($args, 'parentSelector');
    $parentSelectorExists: map.get($args, 'parentSelectorExists');

    $isClrModeDefault: map.get($args, 'isClrModeDefault');

    $debug: map.get($args, 'debug');

    /// Setting using selectors
    @if $includeSelectors {
        $selectors: selectors-colour-mode(
            $modes: $modes,
            $args...,
        );

        @if list.length($selectors) > 0 {
            @at-root #{$selectors} {
                @content;
            }
        }
    }

    /// Setting using media queries
    @if $includeQuery {
        $queries: media-queries-colour-mode(
            $modes: $modes,
            $args...,
        );

        @if list.length($queries) > 0 {
            @at-root {
                @media #{$queries} {
                    #{$parentSelector} {
                        @content;
                    }
                }
            }
        }
    }
}

///
/// Conditional rules for negating various colour modes.  When multiple modes
/// are passed, the selectors are joined (as a list), not unified or merged.  To
/// require more than one mode, nest them.
///
/// @since 0.1.0-pre.0
///
@mixin colour-mode-not(
    $modes,
    $includeQuery: true,
    $includeSelectors: true,

    $modeArgs: false,
    $args...
) {
    @if not $modeArgs {
        $args: colour-mode-validate-args(
            $modes: $modes,
            $args...,
        );
    } @else {
        $args: meta.keywords($args);
    }

    $modes: map.get($args, 'modes');
    $includeDefault: map.get($args, 'includeDefault');

    $nestParentSelector: map.get($args, 'nestParentSelector');
    $unifyParentSelector: map.get($args, 'unifyParentSelector');
    $wrapParentSelector: map.get($args, 'wrapParentSelector');

    $parentSelector: map.get($args, 'parentSelector');
    $parentSelectorExists: map.get($args, 'parentSelectorExists');

    $isClrModeDefault: map.get($args, 'isClrModeDefault');

    $debug: map.get($args, 'debug');

    /// Setting using selectors
    @if $includeSelectors {
        $selectors: selectors-colour-mode(
            $modes: $modes,
            $args...,
        );

        @if list.length($selectors) > 0 {
            @at-root :not(#{$selectors}) {
                @content;
            }
        }
    }

    /// Setting using media queries
    @if $includeQuery {
        $queries: media-queries-colour-mode(
            $modes: $modes,
            $args...,
        );

        @if list.length($queries) > 0 {
            @at-root {
                @media not ( #{$queries} ) {
                    #{$parentSelector} {
                        @content;
                    }
                }
            }
        }
    }
}

//#region Individual colour modes
@mixin light($args...) {
    @include colour-mode('light', $args...) {
        @content;
    }
}
@mixin dark($args...) {
    @include colour-mode('dark', $args...) {
        @content;
    }
}
@mixin low-contrast($args...) {
    @include colour-mode('low', $args...) {
        @content;
    }
}
@mixin average-contrast($args...) {
    @include colour-mode('average', $args...) {
        @content;
    }
}
@mixin high-contrast($args...) {
    @include colour-mode('high', $args...) {
        @content;
    }
}
@mixin max-contrast($args...) {
    @include colour-mode('max', $args...) {
        @content;
    }
}
@mixin forced-colors($args...) {
    @include colour-mode('forced-colors', $args...) {
        @content;
    }
}
//#endregion Individual colour modes

@mixin colour-mode-all($includeForcedColors: true, $args...) {
    $allModes: list.join($_brightnessModes, $_contrastModes);

    @if not $includeForcedColors {
        $allModes: list.except($allModes, forced-colors);
    }

    @include colour-mode($modes: $allModes, $args...) {
        @content;
    }
}

/// ## Each Colour Mode ==================================== ///

///
/// Iterates though brightness modes, and within that it iterates through
/// contrast modes. Content is using $brightness, $contrast.
///
/// @since 0.1.0-pre.0
///
@mixin colour-mode-each(
    $includeQuery: true,
    $includeSelectors: true,

    $includeForcedColors: true,
    $nestModeSelectors: false,

    $nestParentSelector: false,
    $unifyParentSelector: true,
    $wrapParentSelector: false,

    $includeDefault: true,
    $includeRegions: true,
    $includeRegions_heading: '',

    $args...
) {
    $args: meta.keywords($args);

    $selectors_parentOrRoot: selector.parent-or-root();
    $parentSelectorExists: selector.parent-exists();

    $args: map.set($args, 'includeQuery', $includeQuery);
    $args: map.set($args, 'includeSelectors', $includeSelectors);

    $args: map.set($args, 'ignoreParentSelector', true);
    $args: map.set($args, 'includeDefault', false);

    // iterate through brightness modes
    @each $brightness in $_brightnessModes {
        // local args
        $brightness_args: colour-mode-validate-args(
            $modes: $brightness,
            $args...,
        );

        $brightnessIsDefault: is-colour-mode-default($brightness);

        $queries_brightness: media-queries-colour-mode($brightness_args...);

        // iterate through contrast modes
        @each $contrast in $_contrastModes {
            @if $contrast != forced-colors {
                // local args
                $contrast_args: colour-mode-validate-args(
                    $modes: $contrast,
                    $args...,
                );

                $contrastIsDefault: is-colour-mode-default($contrast);

                $queries_contrast: media-queries-colour-mode($contrast_args...);

                $includeSelectors: if(
                    (
                        map.get($brightness_args, 'includeSelectors') and
                            map.get($contrast_args, 'includeSelectors')
                    ),
                    true,
                    false
                );

                $includeQuery: if(
                    (
                        map.get($brightness_args, 'includeQuery') and
                            map.get($contrast_args, 'includeQuery')
                    ),
                    true,
                    false
                );

                @at-root {
                    @if $includeRegions {
                        @if $contrast == forced-colors {
                            /* #region #{$includeRegions_heading}#{$contrast} contrast */
                        } @else {
                            /* #region #{$includeRegions_heading}#{$brightness} mode + #{$contrast} contrast */
                        }
                    }

                    @if $includeSelectors {
                        // here to reset if body selector is added for default modes
                        $selectors_brightness: selectors-colour-mode(
                            $brightness_args...
                        );

                        $selectors_contrast: selectors-colour-mode(
                            $contrast_args...
                        );

                        $selectors_merged: selector.unify(
                            '#{$selectors_brightness}',
                            '#{$selectors_contrast}'
                        );

                        @if $nestModeSelectors {
                            $selectors_merged: list.join(
                                $selectors_merged,
                                selector.merge(
                                    $selectors_brightness,
                                    $selectors_contrast,
                                    //
                                    $nestAinB: true,
                                    $nestBinA: true,
                                    $unify: false
                                ),
                                $separator: comma
                            );
                        }

                        // now we can do unifying, etc. as appropriate
                        @if selector.parent-exists() {
                            $selectors_brightness: selector.merge(
                                $selectorA: $selectors_parentOrRoot,
                                $selectorB: $selectors_brightness,

                                $nestAinB: $nestParentSelector,
                                $nestBinA: $wrapParentSelector,
                                $unify: $unifyParentSelector,
                            );

                            $selectors_contrast: selector.merge(
                                $selectorA: $selectors_parentOrRoot,
                                $selectorB: $selectors_contrast,

                                $nestAinB: $nestParentSelector,
                                $nestBinA: $wrapParentSelector,
                                $unify: $unifyParentSelector,
                            );

                            $selectors_merged: selector.merge(
                                $selectorA: $selectors_parentOrRoot,
                                $selectorB: $selectors_merged,

                                $nestAinB: $nestParentSelector,
                                $nestBinA: $wrapParentSelector,
                                $unify: $unifyParentSelector,
                            );
                        }

                        // first we may have to adjust the selectors
                        @if $includeDefault {
                            @if $brightnessIsDefault and $contrastIsDefault {
                                // = the body element is part of the selectors here

                                $selectors_merged: (
                                    $selectors_parentOrRoot,
                                    $selectors_brightness,
                                    $selectors_contrast,
                                    $selectors_merged
                                );
                            } @else if
                                $brightnessIsDefault and not
                                $contrastIsDefault
                            {
                                // = the body element needs to be "merged" with the contrast selectors

                                $selectors_merged: (
                                    // $selectors_contrast,
                                    if(
                                            $parentSelectorExists,
                                            selector.unify(
                                                '#{$selectors_parentOrRoot}',
                                                '#{$selectors_contrast}'
                                            ),
                                            $selectors_contrast
                                        ),
                                    $selectors_merged
                                );
                            } @else if not
                                $brightnessIsDefault and
                                $contrastIsDefault
                            {
                                // = the body element needs to be "merged" with the brightness selectors

                                $selectors_merged: (
                                    // $selectors_brightness,
                                    if(
                                            $parentSelectorExists,
                                            selector.unify(
                                                '#{$selectors_parentOrRoot}',
                                                '#{$selectors_brightness}'
                                            ),
                                            $selectors_brightness
                                        ),
                                    $selectors_merged
                                );
                            }
                        }

                        // includes default selector(s) as applicable
                        // /* merged selectors */
                        #{$selectors_merged} {
                            @content ( $brightness, $contrast );
                        }

                        @if $includeQuery {
                            @if list.length($queries_contrast) > 0 {
                                $_sel: if(
                                    $brightnessIsDefault and $includeDefault,
                                    (
                                        $selectors_parentOrRoot,
                                        $selectors_brightness
                                    ),
                                    $selectors_brightness
                                );

                                // /* #{$contrast} contrast queries + #{$brightness} mode selectors */
                                @media #{$queries_contrast} {
                                    #{$_sel} {
                                        @content ( $brightness, $contrast );
                                    }
                                }
                            }

                            @if list.length($queries_brightness) > 0 {
                                $_sel: if(
                                    $contrastIsDefault and $includeDefault,
                                    (
                                        $selectors_parentOrRoot,
                                        $selectors_contrast
                                    ),
                                    $selectors_contrast
                                );

                                // /* #{$brightness} mode queries + #{$contrast} contrast selectors */
                                @media #{$queries_brightness} {
                                    #{$_sel} {
                                        @content ( $brightness, $contrast );
                                    }
                                }
                            }
                        }
                    }

                    @if $includeQuery {
                        // builds a list of queries to apply at once
                        $queries: ();

                        // if the selectors aren't included, then we have to combine the
                        // parent selector here, and potentially include default
                        @if not $includeSelectors {
                            @if $brightnessIsDefault and $contrastIsDefault {
                                // we need to include the defaults anyway
                                /* default values */
                                #{$selectors_parentOrRoot} {
                                    @content ( $brightness, $contrast );
                                }
                            }

                            @if $brightnessIsDefault {
                                // brightness selector + contrast queries
                                $queries: list.append(
                                    $queries,
                                    $queries_contrast,
                                    $separator: 'comma'
                                );
                            }

                            @if $contrastIsDefault {
                                // contrast selector + brightness queries
                                $queries: list.append(
                                    $queries,
                                    $queries_brightness,
                                    $separator: 'comma'
                                );
                            }
                        }

                        // adding the merged queries together, one-by-one
                        @each $bright_query in $queries_brightness {
                            @each $con_query in $queries_contrast {
                                $queries: list.append(
                                    $queries,
                                    string.unquote(
                                        '(#{$bright_query} and #{$con_query})'
                                    ),
                                    $separator: 'comma'
                                );
                            }
                        }

                        // if queries exist, print them with content
                        @if list.length($queries) > 0 {
                            // /* merged queries */
                            @media #{$queries} {
                                #{$selectors_parentOrRoot} {
                                    @content ( $brightness, $contrast );
                                }
                            }
                        }
                    }

                    @if $includeRegions {
                        @if $contrast == forced-colors {
                            /* #endregion #{$includeRegions_heading}#{$contrast} contrast */
                        } @else {
                            /* #endregion #{$includeRegions_heading}#{$brightness} mode + #{$contrast} contrast */
                        }
                    }
                }
            }
        }
    }

    @if $includeForcedColors {
        $contrast: forced-colors;
        // local args
        $forced_args: colour-mode-validate-args(
            $modes: $contrast,
            $args...,
        );

        $contrastIsDefault: is-colour-mode-default($contrast);

        $forced_queries: media-queries-colour-mode($forced_args...);

        $includeSelectors: map.get($forced_args, 'includeSelectors');

        $includeDefault: map.get($forced_args, 'includeDefault');

        @at-root {
            @if $includeRegions {
                /* #region #{$includeRegions_heading}#{$contrast} */
            }

            @if $contrastIsDefault and $includeDefault and $includeSelectors {
                #{$selectors_parentOrRoot} {
                    @content ( $brightness: tokens.$brightnessMode_default, $contrast: $contrast );
                }
            }

            // if queries exist, print them with content
            @if list.length($forced_queries) > 0 {
                @media #{$forced_queries} {
                    #{$selectors_parentOrRoot} {
                        @content ( $brightness: tokens.$brightnessMode_default, $contrast: $contrast );
                    }
                }
            }

            @if $includeRegions {
                /* #endregion #{$includeRegions_heading}#{$contrast} */
            }
        }
    }
}

/// ## Colour Mode - with JS Support ==================================== ///

@mixin _colour-mode-js-any-support($modes, $key, $bool, $args...) {
    $selector: #{&};

    $args: meta.keywords($args);

    $mixin: if(
        $bool,
        meta.get-mixin('js-support'),
        meta.get-mixin('js-no-support')
    );

    $hasDefaultMode: false;

    @each $mode in $modes {
        @if is-colour-mode-default($mode) {
            $hasDefaultMode: true;
        }
    }

    @if config.$selectorType_mode != 'null-selector' or $hasDefaultMode {
        $addSelectors: if(
            $hasDefaultMode,
            (
                selector-feature-check(
                    $key: $key,
                    $bool: $bool,
                    $args...,
                )
            ),
            ()
        );

        $addSelectors_noJS: if(
            (
                config.$include_featureCheck and
                    $hasDefaultMode and not
                    $bool and
                    $key !=
                    whereSelector
            ),
            (
                selector-feature-check(
                    $key: null,
                    $bool: $bool,
                    $args...,
                )
            ),
            ()
        );

        @include meta.apply(
            $mixin: $mixin,
            $key: $key,
            $replaceRootSelector: selectors-colour-mode(
                    $modes: $modes,
                    $ignoreParentSelector: true,
                    $includeDefault: false,
                    $args...
                ),
            $addSelectors: $addSelectors,
            $addSelectors_noJS: $addSelectors_noJS,
            $args...
        ) {
            @content;
        }
    }

    @at-root {
        @include colour-mode(
            $modes: $modes,
            $includeSelectors: false,
            $parentSelector: (
                $selector,
            ),
            $args...
        ) {
            @include meta.apply($mixin: $mixin, $key: $key, $args...) {
                @content;
            }
        }
    }
}

@mixin colour-mode-js-support($modes, $key, $args...) {
    $args: meta.keywords($args);

    @include _colour-mode-js-any-support(
        $modes: $modes,
        $key: $key,
        $bool: true,
        $args...
    ) {
        @content;
    }
}

@mixin colour-mode-js-no-support($modes, $key, $args...) {
    $args: meta.keywords($args);

    @include _colour-mode-js-any-support(
        $modes: $modes,
        $key: $key,
        $bool: false,
        $args...
    ) {
        @content;
    }
}

/// ## Colour Mode - with Interactivity ==================================== ///

@mixin colour-mode-interactive-mixin(
    $modes,
    $active: false,
    $focus: false,
    $focusWithin: false,
    $hover: false,
    $visited: false,
    $args...
) {
    @if config.$include_featureCheck and $focus {
        @include colour-mode-js-no-support(
            $modes: $modes,
            $key: 'focusVisible',
            $args...
        ) {
            @if $focus {
                &:focus {
                    @content;
                }
            }
        }
    }

    @include colour-mode($modes: $modes, $args...) {
        @if $focus and config.$include_featureCheck {
            &:focus-visible {
                @content;
            }
        }

        @if $focusWithin {
            &:focus-within {
                @content;
            }
        }

        @if $hover or $active or $visited {
            #{(
                if($focus and not config.$include_featureCheck, '&:focus', config.$selector_null),
                if($hover, '&:hover', config.$selector_null),
                if($active, '&:active', config.$selector_null),
                if($visited, '&:visited', config.$selector_null),
            )} {
                @content;
            }
        }
    }
}
