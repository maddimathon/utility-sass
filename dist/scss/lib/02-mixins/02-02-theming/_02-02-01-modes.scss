///
/// @package @maddimathon/utility-sass@0.1.0-alpha.1
/// @since 0.1.0-pre.0
///

@use '../../../modules/feature-check';
@use '../../../modules/list';
@use '../../../modules/map';
@use '../../../modules/meta';
@use '../../../modules/selector';
@use '../../../modules/string';

@use '../../../config';
@use '../../../tokens';

@use '../../01-functions' as *;

@use '../02-01-utilities' as *;
// @use '../02-02-theming' as *;

/// # THEMING MIXINS - Modes
/// ======================================================================== ///

$_brightnessModes: filter-colour-modes-active-only(tokens.$brightnessMode_all);
$_contrastModes: filter-colour-modes-active-only(tokens.$contrastMode_all);

///
/// Conditional rules for various colour modes.  When multiple modes are passed,
/// the selectors are joined (as a list), not unified or merged.  To require
/// more than one mode, nest them.
///
/// @since 0.1.0-pre.0
///
@mixin colour-mode(
    $modes,
    $includeQuery: config.$mx_colourMode_includeQuery_default,
    $includeSelectors: config.$mx_colourMode_includeSelectors_default,

    $modeArgs: false,
    $args...
) {
    @if not $modeArgs {
        $args: colour-mode-validate-args(
            $modes: $modes,
            $args...,
        );
    } @else {
        $args: meta.keywords($args);
    }

    $modes: map.get($args, 'modes');
    $includeDefault: map.get($args, 'includeDefault');

    $nestParentSelector: map.get($args, 'nestParentSelector');
    $unifyParentSelector: map.get($args, 'unifyParentSelector');
    $wrapParentSelector: map.get($args, 'wrapParentSelector');

    $parentSelector: map.get($args, 'parentSelector');
    $parentSelectorExists: map.get($args, 'parentSelectorExists');

    $isClrModeDefault: map.get($args, 'isClrModeDefault');

    $debug: map.get($args, 'debug');

    /// Setting using media queries
    @if $includeQuery {
        $queries: media-queries-colour-mode(
            $modes: $modes,
            $args...,
        );

        @if list.length($queries) > 0 {
            @at-root {
                @media #{$queries} {
                    #{$parentSelector} {
                        @content;
                    }
                }
            }
        }
    }

    /// Setting using selectors
    @if $includeSelectors {
        $selectors: selectors-colour-mode(
            $modes: $modes,
            $args...,
        );

        @if list.length($selectors) > 0 {
            @at-root #{$selectors} {
                @content;
            }
        }
    }
}

///
/// Conditional rules for negating various colour modes.  When multiple modes
/// are passed, the selectors are joined (as a list), not unified or merged.  To
/// require more than one mode, nest them.
///
/// @since 0.1.0-pre.0
///
@mixin colour-mode-not(
    $modes,
    $includeQuery: config.$mx_colourMode_includeQuery_default,
    $includeSelectors: config.$mx_colourMode_includeSelectors_default,

    $modeArgs: false,
    $args...
) {
    @if not $modeArgs {
        $args: colour-mode-validate-args(
            $modes: $modes,
            $args...,
        );
    } @else {
        $args: meta.keywords($args);
    }

    $modes: map.get($args, 'modes');
    $includeDefault: map.get($args, 'includeDefault');

    $nestParentSelector: map.get($args, 'nestParentSelector');
    $unifyParentSelector: map.get($args, 'unifyParentSelector');
    $wrapParentSelector: map.get($args, 'wrapParentSelector');

    $parentSelector: map.get($args, 'parentSelector');
    $parentSelectorExists: map.get($args, 'parentSelectorExists');

    $isClrModeDefault: map.get($args, 'isClrModeDefault');

    $debug: map.get($args, 'debug');

    /// Setting using selectors
    @if $includeSelectors {
        $selectors: selectors-colour-mode(
            $modes: $modes,
            $args...,
        );

        @if list.length($selectors) > 0 {
            @at-root :not(#{$selectors}) {
                @content;
            }
        }
    }

    /// Setting using media queries
    @if $includeQuery {
        $queries: media-queries-colour-mode(
            $modes: $modes,
            $args...,
        );

        @if list.length($queries) > 0 {
            @at-root {
                @media not ( #{$queries} ) {
                    #{$parentSelector} {
                        @content;
                    }
                }
            }
        }
    }
}

//#region Individual colour modes
@mixin light($args...) {
    @include colour-mode('light', $args...) {
        @content;
    }
}
@mixin dark($args...) {
    @include colour-mode('dark', $args...) {
        @content;
    }
}
@mixin low-contrast($args...) {
    @include colour-mode('low', $args...) {
        @content;
    }
}
@mixin average-contrast($args...) {
    @include colour-mode('average', $args...) {
        @content;
    }
}
@mixin high-contrast($args...) {
    @include colour-mode('high', $args...) {
        @content;
    }
}
@mixin max-contrast($args...) {
    @include colour-mode('max', $args...) {
        @content;
    }
}
@mixin forced-colors($args...) {
    @include colour-mode('forced-colors', $args...) {
        @content;
    }
}
//#endregion Individual colour modes

@mixin colour-mode-all($includeForcedColors: true, $args...) {
    $allModes: list.join($_brightnessModes, $_contrastModes);

    @if not $includeForcedColors {
        $allModes: list.except($allModes, forced-colors);
    }

    @include colour-mode($modes: $allModes, $args...) {
        @content;
    }
}

/// ## Each Colour Mode ==================================== ///

@mixin _colour-mode-each-single-set(
    $brightness_args,
    $brightness,
    $brightnessIsDefault,
    $contrast_args,
    $contrast,
    $contrastIsDefault,
    $includeDefault,
    $includeQuery,
    $includeRegions_heading,
    $includeRegions,
    $includeSelectors,
    $nestModeSelectors,
    $nestParentSelector,
    $unifyParentSelector,
    $wrapParentSelector
) {
    $selectors_parentOrRoot: selector.parent-or-root();
    $parentSelectorExists: selector.parent-exists();

    $queries_brightness: media-queries-colour-mode($brightness_args...);
    $queries_contrast: media-queries-colour-mode($contrast_args...);

    $selectors_brightness: selectors-colour-mode($brightness_args...);
    $selectors_contrast: selectors-colour-mode($contrast_args...);

    $brightnessIsMultipleAndDefault: (
        meta.type-of($brightness) == list and $brightnessIsDefault
    );
    $contrastIsMultipleAndDefault: (
        meta.type-of($contrast) == list and $contrastIsDefault
    );

    @at-root {
        @if $includeRegions {
            /* #region #{$includeRegions_heading}#{$brightness} mode + #{$contrast} contrast */
        } @else {
            /* #{$includeRegions_heading}#{$brightness} mode + #{$contrast} contrast */
        }

        @if $includeQuery {
            // builds a list of queries to apply at once
            $_queries: ();

            $_queries_brightness: $queries_brightness;
            $_queries_contrast: $queries_contrast;
            $_selectors_parentOrRoot: $selectors_parentOrRoot;

            // if the selectors aren't included, then we have to combine the
            // parent selector here, and potentially include default
            //
            // or, if there are multiple modes and one is default (e.g., forced-colors)
            @if not $includeSelectors {
                @if $brightnessIsDefault and $contrastIsDefault {
                    // we need to include the defaults anyway
                    #{$_selectors_parentOrRoot} {
                        @content;
                    }
                }

                @if $brightnessIsDefault {
                    // brightness selector + contrast queries
                    $_queries: list.append(
                        $_queries,
                        ($_queries_contrast),
                        $separator: 'comma'
                    );
                }

                @if $contrastIsDefault {
                    // contrast selector + brightness queries
                    $_queries: list.append(
                        $_queries,
                        ($_queries_brightness),
                        $separator: 'comma'
                    );
                }
            }

            // if there are multiple modes and one is default
            // (e.g., forced-colors) we have to add in more queries AND
            // more root selectors
            @if $includeSelectors and
                (
                    $brightnessIsMultipleAndDefault or
                        $contrastIsMultipleAndDefault
                )
            {
                @if $brightnessIsDefault {
                    // brightness selector + contrast queries
                    $_queries: list.append(
                        $_queries,
                        ($_queries_contrast),
                        $separator: 'comma'
                    );
                }

                @if $contrastIsDefault {
                    // contrast selector + brightness queries
                    $_queries: list.append(
                        $_queries,
                        ($_queries_brightness),
                        $separator: 'comma'
                    );
                }

                @if $brightnessIsDefault and $contrastIsDefault {
                    // = the body element is part of the selectors here

                    $_selectors_parentOrRoot: (
                        $_selectors_parentOrRoot,
                        $selectors_brightness,
                        $selectors_contrast
                    );
                } @else if $brightnessIsDefault and not $contrastIsDefault {
                    // = the body element needs to be "merged" with the contrast selectors

                    $_selectors_parentOrRoot: (
                        $_selectors_parentOrRoot,
                        if(
                            $parentSelectorExists,
                            selector.unify(
                                '#{$selectors_parentOrRoot}',
                                '#{$selectors_brightness}'
                            ),
                            $selectors_brightness
                        )
                    );
                } @else if not $brightnessIsDefault and $contrastIsDefault {
                    // = the body element needs to be "merged" with the brightness selectors

                    $_selectors_parentOrRoot: (
                        $_selectors_parentOrRoot,
                        if(
                            $parentSelectorExists,
                            selector.unify(
                                '#{$selectors_parentOrRoot}',
                                '#{$selectors_contrast}'
                            ),
                            $selectors_contrast
                        )
                    );
                }
            }

            // adding the merged queries together, one-by-one
            @if not(
                $brightnessIsMultipleAndDefault or $contrastIsMultipleAndDefault
            )
            {
                @each $bright_query in $_queries_brightness {
                    @each $con_query in $_queries_contrast {
                        $_queries: list.append(
                            $_queries,
                            string.unquote(
                                '(#{$bright_query} and #{$con_query})'
                            ),
                            $separator: 'comma'
                        );
                    }
                }
            }

            // if queries exist, print them with content
            @if list.length($_queries) > 0 and string.length(#{$_queries}) > 0 {
                // /* merged queries */
                @media #{$_queries} {
                    #{$_selectors_parentOrRoot} {
                        @content;
                    }
                }
            }
        }

        @if $includeSelectors {
            // here to reset if body selector is added for default modes

            $selectors_merged: selector.unify(
                '#{$selectors_brightness}',
                '#{$selectors_contrast}'
            );

            @if $nestModeSelectors {
                $selectors_merged: list.join(
                    $selectors_merged,
                    selector.merge(
                        $selectors_brightness,
                        $selectors_contrast,
                        //
                        $nestAinB: true,
                        $nestBinA: true,
                        $unify: false
                    ),
                    $separator: comma
                );
            }

            // now we can do unifying, etc. as appropriate
            @if selector.parent-exists() {
                $selectors_brightness: selector.merge(
                    $selectorA: $selectors_parentOrRoot,
                    $selectorB: $selectors_brightness,

                    $nestAinB: $nestParentSelector,
                    $nestBinA: $wrapParentSelector,
                    $unify: $unifyParentSelector,
                );

                $selectors_contrast: selector.merge(
                    $selectorA: $selectors_parentOrRoot,
                    $selectorB: $selectors_contrast,

                    $nestAinB: $nestParentSelector,
                    $nestBinA: $wrapParentSelector,
                    $unify: $unifyParentSelector,
                );

                $selectors_merged: selector.merge(
                    $selectorA: $selectors_parentOrRoot,
                    $selectorB: $selectors_merged,

                    $nestAinB: $nestParentSelector,
                    $nestBinA: $wrapParentSelector,
                    $unify: $unifyParentSelector,
                );
            }

            // first we may have to adjust the selectors
            @if $includeDefault or
                $brightnessIsMultipleAndDefault or
                $contrastIsMultipleAndDefault
            {
                @if $brightnessIsDefault and $contrastIsDefault {
                    // = the body element is part of the selectors here

                    $selectors_merged: list.join(
                        (
                            $selectors_parentOrRoot,
                            $selectors_brightness,
                            $selectors_contrast
                        ),
                        $selectors_merged,
                        $separator: comma
                    );
                } @else if $brightnessIsDefault and not $contrastIsDefault {
                    // = the body element needs to be "merged" with the contrast selectors

                    $selectors_merged: list.join(
                        if(
                            $parentSelectorExists,
                            selector.unify(
                                '#{$selectors_parentOrRoot}',
                                '#{$selectors_contrast}'
                            ),
                            ($selectors_contrast)
                        ),
                        $selectors_merged,
                        $separator: comma
                    );
                } @else if not $brightnessIsDefault and $contrastIsDefault {
                    // = the body element needs to be "merged" with the brightness selectors

                    $selectors_merged: list.join(
                        if(
                            $parentSelectorExists,
                            selector.unify(
                                '#{$selectors_parentOrRoot}',
                                '#{$selectors_brightness}'
                            ),
                            ($selectors_brightness)
                        ),
                        $selectors_merged,
                        $separator: comma
                    );
                }
            }

            // we may have to adjust the queries
            @if $includeQuery and not
                (
                    $brightnessIsMultipleAndDefault or
                        $contrastIsMultipleAndDefault
                )
            {
                @if list.length($queries_contrast) > 0 {
                    $_sel: if(
                        $brightnessIsDefault and $includeDefault,
                        ($selectors_parentOrRoot, $selectors_brightness),
                        $selectors_brightness
                    );

                    // /* #{$contrast} contrast queries + #{$brightness} mode selectors */
                    @media #{$queries_contrast} {
                        #{$_sel} {
                            @content;
                        }
                    }
                }

                @if list.length($queries_brightness) >
                    0 and
                    (
                        #{$contrast} !=
                            forced-colors or
                            config.$mx_colourModeEach_includeSelectors_forcedColors
                    )
                {
                    $_sel: if(
                        $contrastIsDefault and $includeDefault,
                        ($selectors_parentOrRoot, $selectors_contrast),
                        $selectors_contrast
                    );

                    // /* #{$brightness} mode queries + #{$contrast} contrast selectors */
                    @media #{$queries_brightness} {
                        #{$_sel} {
                            @content;
                        }
                    }
                }
            }

            // includes default selector(s) as applicable
            @if (
                #{$contrast} !=
                    forced-colors or
                    config.$mx_colourModeEach_includeSelectors_forcedColors
            ) {
                #{$selectors_merged} {
                    @content;
                }
            }
        }

        @if $includeRegions {
            /* #endregion #{$includeRegions_heading}#{$brightness} mode + #{$contrast} contrast */
        }
    }
}

///
/// Iterates though brightness modes, and within that it iterates through
/// contrast modes. Content is using $brightness, $contrast.
///
/// @since 0.1.0-pre.0
///
@mixin colour-mode-each(
    $includeQuery: config.$mx_colourMode_includeQuery_default,
    $includeSelectors: config.$mx_colourMode_includeSelectors_default,

    $includeForcedColors: true,
    $nestModeSelectors: false,

    $nestParentSelector: false,
    $unifyParentSelector: true,
    $wrapParentSelector: false,

    $includeDefault: true,
    $includeRegions: true,
    $includeRegions_heading: '',

    /// @param {boolean} $iterateForcedColors  Whether to include forced-colors for each brightness mode.
    $iterateForcedColors: false,

    $args...
) {
    $args: meta.keywords($args);

    $args: map.set($args, 'includeQuery', $includeQuery);
    $args: map.set($args, 'includeSelectors', $includeSelectors);

    $args: map.set($args, 'ignoreParentSelector', true);
    $args: map.set($args, 'includeDefault', false);

    // iterate through brightness modes
    @each $brightness in $_brightnessModes {
        // local args
        $brightness_args: colour-mode-validate-args(
            $modes: $brightness,
            $args...,
        );

        $brightnessIsDefault: is-colour-mode-default($brightness);

        // iterate through contrast modes
        @each $contrast in $_contrastModes {
            @if $contrast !=
                forced-colors or
                ($includeForcedColors and $iterateForcedColors)
            {
                // local args
                $contrast_args: colour-mode-validate-args(
                    $modes: $contrast,
                    $args...,
                );

                @include _colour-mode-each-single-set(
                    $brightness: $brightness,
                    $brightness_args: $brightness_args,
                    $brightnessIsDefault: $brightnessIsDefault,
                    $contrast: $contrast,
                    $contrast_args: $contrast_args,
                    $contrastIsDefault: is-colour-mode-default($contrast),
                    $includeDefault: $includeDefault,
                    $includeQuery: if(
                            (
                                map.get($brightness_args, 'includeQuery') and
                                    map.get($contrast_args, 'includeQuery')
                            ),
                            true,
                            false
                        ),
                    $includeRegions_heading: $includeRegions_heading,
                    $includeRegions: $includeRegions,
                    $includeSelectors: if(
                            (
                                map.get($brightness_args, 'includeSelectors')
                                    and
                                    map.get($contrast_args, 'includeSelectors')
                            ),
                            true,
                            false
                        ),
                    $nestModeSelectors: $nestModeSelectors,
                    $nestParentSelector: $nestParentSelector,
                    $unifyParentSelector: $unifyParentSelector,
                    $wrapParentSelector: $wrapParentSelector
                ) {
                    @content ( $brightness, $contrast );
                }
            }
        }
    }

    @if $includeForcedColors and not $iterateForcedColors {
        $brightness: tokens.$brightnessMode_all;
        $contrast: forced-colors;

        // local args
        $forced_args: colour-mode-validate-args(
            $modes: $contrast,
            $args...,
        );

        $all_brightness_args: colour-mode-validate-args(
            $modes: $brightness,
            $args...,
        );

        @include _colour-mode-each-single-set(
            $brightness: $brightness,
            $brightness_args: $all_brightness_args,
            $brightnessIsDefault: true,
            $contrast: $contrast,
            $contrast_args: $forced_args,
            $contrastIsDefault: is-colour-mode-default($contrast),
            $includeDefault: map.get($forced_args, 'includeDefault'),
            $includeQuery: true,
            $includeRegions_heading: $includeRegions_heading,
            $includeRegions: $includeRegions,
            $includeSelectors: map.get($forced_args, 'includeSelectors'),
            $nestModeSelectors: $nestModeSelectors,
            $nestParentSelector: $nestParentSelector,
            $unifyParentSelector: $unifyParentSelector,
            $wrapParentSelector: $wrapParentSelector
        ) {
            @content ( $brightness, $contrast );
        }
    }
}

/// ## Colour Mode - with JS Support ==================================== ///

@mixin _colour-mode-js-any-support($modes, $key, $bool, $args...) {
    $selector: #{&};

    $args: meta.keywords($args);

    $mixin: if(
        $bool,
        meta.get-mixin('js-support', $module: feature-check),
        meta.get-mixin('js-no-support', $module: feature-check)
    );

    $hasDefaultMode: false;

    @each $mode in $modes {
        @if is-colour-mode-default($mode) {
            $hasDefaultMode: true;
        }
    }

    @if config.$selectorType_mode != 'null' or $hasDefaultMode {
        $addSelectors: if(
            $hasDefaultMode,
            (
                feature-check.get-selector(
                    $key: $key,
                    $bool: $bool,
                    $args...,
                )
            ),
            ()
        );

        $addSelectors_noJS: if(
            (
                config.$include_featureCheck and
                    $hasDefaultMode and not
                    $bool and
                    $key !=
                    whereSelector
            ),
            (
                feature-check.get-selector(
                    $key: null,
                    $bool: $bool,
                    $args...,
                )
            ),
            ()
        );

        @include meta.apply(
            $mixin: $mixin,
            $key: $key,
            $replaceRootSelector: selectors-colour-mode(
                    $modes: $modes,
                    $ignoreParentSelector: true,
                    $includeDefault: false,
                    $args...
                ),
            $addSelectors: $addSelectors,
            $addSelectors_noJS: $addSelectors_noJS,
            $args...
        ) {
            @content;
        }
    }

    @at-root {
        @include colour-mode(
            $modes: $modes,
            $includeSelectors: false,
            $parentSelector: (
                $selector,
            ),
            $args...
        ) {
            @include meta.apply($mixin: $mixin, $key: $key, $args...) {
                @content;
            }
        }
    }
}

@mixin colour-mode-js-support($modes, $key, $args...) {
    $args: meta.keywords($args);

    @include _colour-mode-js-any-support(
        $modes: $modes,
        $key: $key,
        $bool: true,
        $args...
    ) {
        @content;
    }
}

@mixin colour-mode-js-no-support($modes, $key, $args...) {
    $args: meta.keywords($args);

    @include _colour-mode-js-any-support(
        $modes: $modes,
        $key: $key,
        $bool: false,
        $args...
    ) {
        @content;
    }
}

/// ## Colour Mode - with Interactivity ==================================== ///

// @mixin colour-mode-interactive-mixin(
//     $modes,
//     $active: false,
//     $focus: false,
//     $focusWithin: false,
//     $hover: false,
//     $visited: false,
//     $args...
// ) {
//     @if config.$include_featureCheck and $focus {
//         @include colour-mode-js-no-support(
//             $modes: $modes,
//             $key: 'focusVisible',
//             $args...
//         ) {
//             @if $focus {
//                 &:focus {
//                     @content;
//                 }
//             }
//         }
//     }

//     @include colour-mode($modes: $modes, $args...) {
//         @if $focus and config.$include_featureCheck {
//             &:focus-visible {
//                 @content;
//             }
//         }

//         @if $focusWithin {
//             &:focus-within {
//                 @content;
//             }
//         }

//         @if $hover or $active or $visited {
//             #{(
//                 if($focus and not config.$include_featureCheck, '&:focus', config.$selector_null),
//                 if($hover, '&:hover', config.$selector_null),
//                 if($active, '&:active', config.$selector_null),
//                 if($visited, '&:visited', config.$selector_null),
//             )} {
//                 @content;
//             }
//         }
//     }
// }
